const axios = require('axios');
const cheerio = require('cheerio');
const fs = require('fs');

const TARGET_URL = 'https://www.matchi.se/facilities/g4pthepadelyard?date=&sport=#ClassActivity-130961';
const ACTIVITY_NAME = 'Master Class With Oscar Marhuenda - Intermediate';
const KNOWN_DATES_FILE = 'known-dates.json';

// IFTTT Configuration
const IFTTT_WEBHOOK_KEY = process.env.IFTTT_WEBHOOK_KEY;
const IFTTT_EVENT_NAME = process.env.IFTTT_EVENT_NAME || 'padel_class_available';

async function checkForNewDates() {
  console.log(`[${new Date().toISOString()}] Starting check...`);
  
  try {
    // Fetch the webpage
    const response = await axios.get(TARGET_URL);
    const html = response.data;
    const $ = cheerio.load(html);
    
    // Find the target activity section
    let targetSection = null;
    $('li').each((i, elem) => {
      const text = $(elem).text();
      if (text.includes(ACTIVITY_NAME)) {
        targetSection = $(elem);
        return false; // break
      }
    });
    
    if (!targetSection) {
      console.error('‚ùå Activity not found on page');
      return;
    }
    
    // Extract dates
    const currentDates = [];
    targetSection.find('a[href*="activities/search"]').each((i, elem) => {
      const href = $(elem).attr('href');
      const idMatch = href.match(/id=(\d+)/);
      const parentText = $(elem).parent().text();
      
      const timeMatch = parentText.match(/(\d{2}:\d{2}\s*-\s*\d{2}:\d{2})/);
      const dateMatch = parentText.match(/\d{4}-\d{2}-\d{2}/);
      const spotsMatch = parentText.match(/(\d+)\/(\d+)/);
      
      if (idMatch && dateMatch) {
        currentDates.push({
          id: idMatch[1],
          date: dateMatch[0],
          time: timeMatch ? timeMatch[1] : null,
          spots: spotsMatch ? `${spotsMatch[1]}/${spotsMatch[2]}` : null,
          bookingUrl: `https://www.matchi.se/activities/search?id=${idMatch[1]}`
        });
      }
    });
    
    console.log(`‚úì Found ${currentDates.length} available dates`);
    
    // Load known dates
    let knownDates = [];
    if (fs.existsSync(KNOWN_DATES_FILE)) {
      const fileContent = fs.readFileSync(KNOWN_DATES_FILE, 'utf8');
      knownDates = JSON.parse(fileContent);
    }
    
    // Find new dates
    const newDates = currentDates.filter(cd => 
      !knownDates.some(kd => kd.id === cd.id)
    );
    
    if (newDates.length > 0 && knownDates.length > 0) {
      console.log(`üéâ Found ${newDates.length} NEW dates!`);
      newDates.forEach(date => {
        console.log(`  - ${date.date} at ${date.time} (${date.spots} spots)`);
      });
      
      await sendIFTTTNotification(newDates);
    } else if (newDates.length > 0 && knownDates.length === 0) {
      console.log('‚ÑπÔ∏è  First run - initializing known dates (no notification sent)');
    } else {
      console.log('‚úì No new dates found');
    }
    
    // Save current dates
    fs.writeFileSync(KNOWN_DATES_FILE, JSON.stringify(currentDates, null, 2));
    console.log(`‚úì Updated known dates file`);
    
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

async function sendIFTTTNotification(dates) {
  if (!IFTTT_WEBHOOK_KEY) {
    console.error('‚ö†Ô∏è  IFTTT_WEBHOOK_KEY not configured - skipping notification');
    return;
  }
  
  const webhookUrl = `https://maker.ifttt.com/trigger/${IFTTT_EVENT_NAME}/with/key/${IFTTT_WEBHOOK_KEY}`;
  
  try {
    const dateList = dates.map(d => 
      `${d.date} at ${d.time} (${d.spots} spots available)`
    ).join('\n');
    
    const firstBookingUrl = dates[0].bookingUrl;
    
    await axios.post(webhookUrl, {
      value1: ACTIVITY_NAME,
      value2: dateList,
      value3: firstBookingUrl
    });
    
    console.log('‚úÖ IFTTT notification sent successfully');
  } catch (error) {
    console.error('‚ùå Failed to send IFTTT notification:', error.message);
  }
}

// Run the check
checkForNewDates();
